<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="theme-color" content="#317EFB" />

        <title>Seafront</title>

        <link rel="stylesheet" href="/css/reset.css" />
        <!-- importing plotly as module fails, so we do this instead -->
        <script src="/vendor/plotly.min.js"></script>
        <script type="importmap">
            {
                "imports": {
                    "alpine": "/vendor/alpine/alpinejs-3-14-9.js",

                    "json5": "/vendor/json5/json5-2-2-3.js",

                    "three": "/vendor/three/three-0-176-0.js",
                    "three/addons/capabilities/WebGL": "/vendor/three-addons/WebGL.min.js",
                    "three/addons/loaders/FontLoader": "/vendor/three-addons/FontLoader.min.js",
                    "three/addons/utils/BufferGeometryUtils": "/vendor/three-addons/BufferGeometryUtils.min.js",

                    "platenavigator": "/src/platenavigator.js",
                    "numberinput": "/src/numberinput.js",
                    "filterselect": "/src/filterselect.js",
                    "microscope_setup": "/src/microscope_setup.js",
                    "channelview": "/src/channelview.js",
                    "tooltip": "/src/tooltip.js",
                    "tabs": "/src/tabs.js",
                    "histogram": "/src/histogram.js",
                    "namespace-parser": "/src/namespace-parser.js"
                }
            }
        </script>

        <script src="/src/init.js" type="module"></script>

        <style>
            .fullwidth {
                width: 100%;
            }

            .clickable {
                cursor: pointer;
            }

            .microscope-busy {
                cursor: wait !important;
            }

            .busy-indicator {
                animation: busyPopIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            .busy-indicator.hide {
                animation: busyPopOut 0.2s ease-in forwards;
            }

            @keyframes busyPopIn {
                from {
                    opacity: 0;
                    transform: translateX(-50%) scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) scale(1);
                }
            }

            @keyframes busyPopOut {
                from {
                    opacity: 1;
                    transform: translateX(-50%) scale(1);
                }
                to {
                    opacity: 0;
                    transform: translateX(-50%) scale(0.8);
                }
            }

            .noselect {
                user-select: none;
            }

            .scrolly {
                overflow-y: auto;
            }
            label[disabled] {
                text-decoration: line-through;
                text-decoration-thickness: 2px;
            }

            /* Machine Config Namespace Styles */
            .machine-config-controls {
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: 1em;
                margin-bottom: 1em;
                padding: 0.5em;
                background-color: var(--bg-color);
                border-radius: 4px;
                align-items: center;
            }

            .button-row {
                display: flex;
                gap: 0.5em;
                flex-wrap: wrap;
            }

            .namespace-tree {
                border: 1px solid var(--border-color);
                border-radius: 4px;
            }

            .namespace-section {
                border-bottom: 1px solid var(--border-color);
            }

            .namespace-section:last-child {
                border-bottom: none;
            }

            .namespace-header {
                display: flex;
                align-items: center;
                gap: 0.5em;
                padding: 0.75em 1em;
                background-color: var(--accent-bg-color);
                border-bottom: 1px solid var(--border-color);
                font-weight: bold;
                user-select: none;
            }

            .namespace-header:hover {
                background-color: var(--strong-bg-color);
            }

            .namespace-child .namespace-header {
                background-color: var(--bg-color);
                padding-left: 2em;
                font-weight: normal;
            }

            .namespace-child .namespace-header:hover {
                background-color: var(--accent-bg-color);
            }

            .item-count {
                font-size: 0.85em;
                color: var(--muted-text-color);
                font-weight: normal;
            }

            .namespace-content {
                padding: 0.5em;
            }

            .namespace-child .namespace-content {
                padding-left: 2em;
            }

            .config-item {
                margin: 0.5em 0;
                padding: 0.75em;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                background-color: var(--bg-color);
            }

            .config-row {
                display: grid;
                grid-template-columns: auto 2fr 3fr auto;
                gap: 1em;
                align-items: start;
            }

            .config-frozen {
                display: flex;
                align-items: center;
            }

            .config-info {
                display: flex;
                flex-direction: column;
                gap: 0.25em;
            }

            .config-handle {
                font-weight: bold;
                font-family: monospace;
                color: var(--accent-color);
            }

            .config-name {
                font-size: 0.9em;
                color: var(--muted-text-color);
            }

            .config-value {
                display: flex;
                align-items: center;
            }

            .config-value input,
            .config-value textarea,
            .config-value select,
            .config-value button {
                width: 100%;
                max-width: 300px;
            }

            .config-kind {
                font-size: 0.8em;
                color: var(--muted-text-color);
                font-style: italic;
                text-align: center;
            }
        </style>

        <link href="/css/tooltip.css" rel="stylesheet" />
        <link href="/css/tabs.css" rel="stylesheet" />
    </head>

    <body
        x-data="microscope_state"
        x-bind:class="{ 'microscope-busy': state && state.is_busy }"
        x-init="await manualInit();
                // Set up watcher after init is complete
                if(_microscope_config) {
                    $watch('_microscope_config', () => {
                        saveCurrentConfig();
                    }, { deep: true });
                }"
    >
        <link rel="stylesheet" href="/css/theme.css" />

        <style>
            .section > :first-child {
                background: var(--highlight-color);
                text-align: center;
            }
            .section > :not(:first-child) {
                padding: 0.3em;
            }
        </style>

        <link href="/css/loadingscreen.css" rel="stylesheet" />
        <div
            id="loadingscreen"
            x-effect="if(initDone)$el.style.display='none';"
        >
            <div id="loadingscreentext">Loading Seafront ...</div>
        </div>

        <!-- Central Error Modal -->
        <div 
            x-show="centralError.show" 
            x-transition.opacity.duration.300ms
            id="error-modal-overlay"
            @click="if($event.target === $el) centralError.show = false"
        >
            <div id="error-modal" @click.stop>
                <div id="error-modal-header">
                    <span>‚ö† Error</span>
                    <button @click="centralError.show = false" id="error-modal-close">&times;</button>
                </div>
                <div id="error-modal-body">
                    <div id="error-modal-title" x-text="centralError.title"></div>
                    <div id="error-modal-message" x-text="centralError.message"></div>
                    <div id="error-modal-timestamp" x-text="formattedErrorTimestamp"></div>
                </div>
                <div id="error-modal-footer">
                    <template x-if="centralError.showReloadButton">
                        <button @click="reloadPage()" id="error-modal-reload">Reload</button>
                    </template>
                    <button @click="centralError.show = false" id="error-modal-ok">OK</button>
                </div>
            </div>
        </div>

        <template x-if="initDone">
            <div id="content">
                <!-- Mock Mode Indicator Banner -->
                <div x-show="mockModeActive"
                     style="grid-area: banner;
                            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                            color: white; padding: 8px 16px; text-align: center;
                            font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 14px;
                            border-bottom: 2px solid #e65100;">
                    ‚ö†Ô∏è Running in offline mock mode - server not available
                </div>

                <!-- Microscope Busy Indicator -->
                <div x-show="showBusyIndicator"
                     x-bind:class="busyIndicatorClass"
                     x-bind:style="{
                         position: 'fixed',
                         top: mockModeActive ? '42px' : '20px',
                         left: '50%',
                         transform: 'translateX(-50%)',
                         zIndex: 9999,
                         background: '#ff6b6b',
                         color: 'white',
                         padding: '12px 24px',
                         borderRadius: '8px',
                         fontWeight: 'bold',
                         boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                         fontSize: '16px',
                         border: '2px solid #ff5252'
                     }">
                    üîí Microscope is busy, please wait...
                </div>

                <style>
                    #content {
                        width: 100vw;
                        height: 100vh;
                        overflow: hidden hidden;

                        display: grid;
                        grid-template:
                            "banner banner" auto
                            "a b" 1fr
                            "f f" auto
                            / 2fr 1fr;

                        #leftcol,
                        #rightcol {
                            width: auto;
                            overflow-x: hidden;

                            height: 100%;
                            overflow-y: hidden;
                        }
                    }
                </style>
                <div id="leftcol" style="grid-area: a">
                    <div x-init="initTabs($el)" id="image-views">
                        <style>
                            #image-views {
                                height: 100%;
                                display: grid;
                                grid-template-rows: min-content 1fr;

                                .tab {
                                    overflow: auto;
                                    height: auto;
                                }
                            }
                        </style>

                        <div tabname="Plate View">
                            <div
                                id="plate"
                                style="width: 100%; aspect-ratio: 3/2"
                                x-init="initPlateNavigator($el, this)"
                            ></div>
                            
                            
                            <!-- Row 1: Legend -->
                            <div style="margin-top: 10px; margin-bottom: 10px;">
                                <span>Legend:</span>
                                <span
                                    x-bind:style="`background:#${matWellColor.toString(16).padStart(6,'0')}A0; padding: 0.25em 0.375em; font-weight: bold;`"
                                    >Well</span
                                >
                                <span
                                    x-bind:style="`background:#${matSiteColor.toString(16).padStart(6,'0')}A0; padding: 0.25em 0.375em; font-weight: bold;`"
                                    >Site</span
                                >
                                <span
                                    @click="pulseObjectiveFov()"
                                    x-bind:style="`background:#${matFovColor.toString(16).padStart(6,'0')}D0; padding: 0.25em 0.375em; font-weight: bold; cursor: pointer;`"
                                    title="Click to pulse the objective marker"
                                    >Objective</span
                                >
                                <span
                                    x-bind:style="`background:#${matForbiddenAreaColor.toString(16).padStart(6,'0')}D0; padding: 0.25em 0.375em; font-weight: bold;`"
                                    >Forbidden Area</span
                                >
                            </div>

                            <!-- Row 2: Mouse position -->
                            <div style="margin-bottom: 10px;">
                                <span
                                    style="cursor: help;"
                                    x-init="enabletooltip($el)"
                                    x-bind:tooltip="'Mouse position in physical space on the plate (shown when mouse is over the plate panel above)'"
                                >Mouse position:</span>
                                <span
                                    style="display: inline-block; margin-left: 10px; padding: 2px 6px; border-radius: 3px; font-size: 0.85em; font-family: monospace; background: var(--weak-bg-color); color: var(--text-color);"
                                    x-text="plateCursorPosition ? `${plateCursorPosition.x.toFixed(1)}, ${plateCursorPosition.y.toFixed(1)} mm` : '‚Äì'"
                                >
                                </span>
                            </div>

                            <!-- Row 3: Mouse controls -->
                            <div style="margin-bottom: 10px;" x-data="{ controlsExpanded: true }">
                                <button
                                    @click="controlsExpanded = !controlsExpanded"
                                    style="padding: 2px 8px; border-radius: 3px; font-size: 0.85em; background: var(--weak-bg-color); color: var(--text-color); border: 1px solid var(--text-color); cursor: pointer; margin-bottom: 8px;"
                                >
                                    <span x-text="controlsExpanded ? '‚ñº' : '‚ñ∂'"></span> Mouse controls
                                </button>
                                <div x-show="controlsExpanded" style="padding: 8px; background: var(--weak-bg-color); border-radius: 3px; font-size: 0.85em;">
                                    <div x-show="plateSelectionMode === 'wells'">
                                        <div>‚Ä¢ Drag = pan view</div>
                                        <div>‚Ä¢ Double-click = move objective</div>
                                        <div>‚Ä¢ Shift+left-click = select single well</div>
                                        <div>‚Ä¢ Shift+left-drag = select wells in area</div>
                                        <div>‚Ä¢ Shift+right-click = deselect single well</div>
                                        <div>‚Ä¢ Shift+right-drag = deselect wells in area</div>
                                    </div>
                                    <div x-show="plateSelectionMode === 'sites'">
                                        <div>‚Ä¢ Drag = pan view</div>
                                        <div>‚Ä¢ Double-click = move objective</div>
                                        <div>‚Ä¢ Shift+left-click = select single site</div>
                                        <div>‚Ä¢ Shift+left-drag = select sites in area</div>
                                        <div>‚Ä¢ Shift+right-click = deselect single site</div>
                                        <div>‚Ä¢ Shift+right-drag = deselect sites in area</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 4: Selection mode -->
                            <div style="margin-bottom: 10px;">
                                <span
                                    style="margin-right: 10px; cursor: help;"
                                    x-init="enabletooltip($el)"
                                    x-bind:tooltip="'Determines what can be selected above. Wells are independent; sites are shared across wells (deselecting a site disables it in all wells)'"
                                >Selection mode:</span>
                                <label style="margin-right: 15px;">
                                    <input type="radio" name="selectionMode" value="wells" x-model="plateSelectionMode" />
                                    Wells
                                </label>
                                <label>
                                    <input type="radio" name="selectionMode" value="sites" x-model="plateSelectionMode" />
                                    Sites
                                </label>
                            </div>
                        </div>
                        <div tabname="Channel View" style="position: relative">
                            <div>
                                <label>Columns</label>
                                <input
                                    type="number"
                                    is="number-input"
                                    min="1"
                                    max="4"
                                    step="1"
                                    x-model.number="channelViewNumCols"
                                    x-init="registerNumberInput($el)"
                                />
                                <button
                                    @click="if(channelViewNumCols<4)channelViewNumCols++"
                                >
                                    +
                                </button>
                                <button
                                    @click="if(channelViewNumCols>1)channelViewNumCols--"
                                >
                                    -
                                </button>
                            </div>
                            <canvas
                                id="c"
                                x-init="initChannelView($el);$watch('theme',()=>view?.updateTheme())"
                            ></canvas>
                            <style>
                                #c {
                                    position: fixed;

                                    /*position and size will be changed later*/
                                    left: 0;
                                    top: 0;
                                    width: 100%;
                                    height: 100%;

                                    display: block;
                                    z-index: -1;
                                }

                                #grid-container {
                                    display: grid;
                                    --num-cols: 3;
                                    grid-template-columns: repeat(
                                        var(--num-cols),
                                        1fr
                                    );

                                    .channel-box-image {
                                        aspect-ratio: 1;
                                        border: 1px solid var(--highlight-color);
                                    }
                                }
                                .channel-display-channelname {
                                    text-align: center;
                                    font-weight: bold;
                                }
                            </style>
                            <div
                                id="grid-container"
                                x-bind:style="`--num-cols:${channelViewNumCols};`"
                            >
                                <!--div x-html="cached_channel_image.get('fluo405').info.timestamp"></div-->
                                <template
                                    x-for="channel in microscope_config.channels.filter(c=>c.enabled)"
                                    :key="channel.handle"
                                >
                                    <div
                                        class="channel-box"
                                        x-bind:channelhandle="channel.handle"
                                    >
                                        <div
                                            class="channel-display-channelname"
                                            x-bind:id="`channel-display-${channel.handle}`"
                                            x-text="channel.name"
                                        ></div>
                                        <div
                                            x-effect="updateChannelCache($el)"
                                            class="channel-box-image"
                                            x-bind:id="`channelview-item-${channel.handle}`"
                                        ></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div tabname="Protocols">
                            <div style="padding: 0.3em">
                                <label>Save current config as (Filename)</label>
                                <input
                                    x-model="configStore_filename"
                                    type="text"
                                    placeholder="filename"
                                />
                                <button @click="storeConfig">Save</button>
                                <label
                                    x-init="enabletooltip($el)"
                                    tooltip="overwrite if file with this name already exists?"
                                    >overwrite?</label
                                >
                                <input
                                    type="checkbox"
                                    x-model.boolean="configStore_overwrite_on_conflict"
                                />
                            </div>
                            <div>
                                <div id="protocol-container">
                                    <style>
                                        #protocol-container {
                                            display: grid;
                                            grid-template-columns:
                                                5em /* load button */
                                                10em /* project */
                                                10em /* plate */
                                                30em /* comment */
                                                6em /* cell line */
                                                14em /* plate type */
                                                14em /* timestamp */
                                                15em /* filename */;
                                            gap: 0.5em 0.3em;
                                        }
                                    </style>

                                    <div style="display: contents">
                                        <div
                                            x-init="enabletooltip($el)"
                                            tooltip="case insensitive filter"
                                        >
                                            Filter By
                                        </div>
                                        <input
                                            type="text"
                                            x-model="protol_list_filters.project_name"
                                            placeholder="project"
                                        />
                                        <input
                                            type="text"
                                            x-model="protol_list_filters.plate_name"
                                            placeholder="plate"
                                        />
                                        <input
                                            type="text"
                                            x-model="protol_list_filters.comment"
                                            placeholder="comment"
                                        />
                                        <input
                                            type="text"
                                            x-model="protol_list_filters.cell_line"
                                            placeholder="cell line"
                                        />
                                        <input
                                            type="text"
                                            x-model="protol_list_filters.plate_type"
                                            placeholder="plate type"
                                        />
                                        <div><!--timestamp--></div>
                                        <input
                                            type="text"
                                            x-model="protol_list_filters.filename"
                                            placeholder="filename"
                                        />
                                    </div>

                                    <div></div>
                                    <div><b>Project Name</b></div>
                                    <div><b>Plate Name</b></div>
                                    <div><b>Comment</b></div>
                                    <div><b>Cell Line[s</b>]</div>
                                    <div><b>Plate Type</b></div>
                                    <div><b>Timestamp</b></div>
                                    <div><b>Filename</b></div>

                                    <template
                                        x-for="protocol in filtered_protocol_list"
                                        :key="protocol.filename"
                                    >
                                        <div style="display: contents">
                                            <div>
                                                <button
                                                    @click="await loadConfig(protocol);$nextTick(()=>{configIsStored=true;});"
                                                >
                                                    Load
                                                </button>
                                            </div>
                                            <div
                                                x-text="protocol.project_name"
                                            ></div>
                                            <div
                                                x-text="protocol.plate_name"
                                            ></div>
                                            <div
                                                x-text="protocol.comment"
                                            ></div>
                                            <div
                                                x-text="protocol.cell_line"
                                            ></div>

                                            <div
                                                x-init="enabletooltip($el)"
                                                x-bind:tooltip="`
												Manufacturer: ${protocol.plate_type.Manufacturer}
												Model Name: ${protocol.plate_type.Model_name}
												Model ID: ${protocol.plate_type.Model_id}
											`"
                                                x-text="protocol.plate_type.Model_id"
                                            ></div>

                                            <div
                                                x-text="protocol.timestamp"
                                            ></div>
                                            <div
                                                x-text="protocol.filename"
                                            ></div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div>
                                <button
                                    @click="protocol_list=(await getConfigList()).configs"
                                >
                                    refresh list
                                </button>
                            </div>
                        </div>
                        <div id="machineconfigtab" tabname="Machine Config">
                            <div class="machine-config-controls">
                                <div>
                                    <label>
                                        <input type="checkbox" x-model="machineConfigUseNamespaces" />
                                        Use hierarchical view
                                    </label>
                                </div>
                                <div>
                                    <label>filter handles</label>
                                    <input
                                        type="text"
                                        x-model="machineConfigHandleFilter"
                                        placeholder="filter handles containing this"
                                    />
                                </div>
                                <div class="button-row">
                                    <button @click="expandAllNamespaces()" x-show="machineConfigUseNamespaces">
                                        Expand All
                                    </button>
                                    <button @click="collapseAllNamespaces()" x-show="machineConfigUseNamespaces">
                                        Collapse All
                                    </button>
                                    <button @click="machineConfigReset">
                                        Reset All
                                    </button>
                                    <button @click="machineConfigFlush">
                                        Flush to Server
                                    </button>
                                </div>
                            </div>

                            <!-- Hierarchical namespace view -->
                            <div x-show="machineConfigUseNamespaces" class="namespace-tree">
                                <template x-for="namespace in machineConfigNamespaces" :key="namespace.path">
                                    <div class="namespace-section">
                                        <div 
                                            class="namespace-header clickable"
                                            @click="toggleNamespaceExpansion(namespace)"
                                        >
                                            <span x-text="namespace.isExpanded ? '‚ñº' : '‚ñ∂'"></span>
                                            <strong x-text="namespace.name"></strong>
                                            <span class="item-count" x-text="`(${namespace.items.length} items)`"></span>
                                        </div>
                                        
                                        <!-- Items in this namespace -->
                                        <div x-show="namespace.isExpanded" class="namespace-content">
                                            <template x-for="config in namespace.items" :key="config.handle">
                                                <div 
                                                    class="config-item"
                                                    x-show="!machineConfigHandleFilter || config.handle.toLowerCase().includes(machineConfigHandleFilter.toLowerCase())"
                                                >
                                                    <div class="config-row">
                                                        <div class="config-frozen">
                                                            <input
                                                                x-bind:id="`machineconfig-${config.handle}-frozen`"
                                                                type="checkbox"
                                                                x-model.boolean="config.frozen"
                                                                x-init="disableElement($el,()=>(config.frozen||config.value_kind=='action'))"
                                                            />
                                                        </div>
                                                        <div class="config-info">
                                                            <label
                                                                x-bind:for="`machineconfig-${config.handle}-frozen`"
                                                                class="config-handle"
                                                                x-text="config.handle"
                                                            ></label>
                                                            <div class="config-name" x-text="config.name"></div>
                                                        </div>
                                                        <div class="config-value">
                                                            <template x-if="config.value_kind=='int'">
                                                                <input
                                                                    type="number"
                                                                    step="1"
                                                                    x-model.number="config.value"
                                                                    is="number-input"
                                                                    x-init="registerNumberInput($el)"
                                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                                />
                                                            </template>
                                                            <template x-if="config.value_kind=='float'">
                                                                <input
                                                                    type="number"
                                                                    step="0.01"
                                                                    x-model.number="config.value"
                                                                    is="number-input"
                                                                    x-init="registerNumberInput($el)"
                                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                                />
                                                            </template>
                                                            <template x-if="config.value_kind=='text'">
                                                                <textarea
                                                                    rows="2"
                                                                    wrap="soft"
                                                                    x-model="config.value"
                                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                                ></textarea>
                                                            </template>
                                                            <template x-if="config.value_kind=='action'">
                                                                <button
                                                                    x-text="config.value"
                                                                    @click="await runMachineConfigAction(config)"
                                                                ></button>
                                                            </template>
                                                            <template x-if="config.value_kind=='option'">
                                                                <select
                                                                    x-model="config.value"
                                                                    x-init="$el.value=config.value"
                                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                                >
                                                                    <template x-for="option in config.options" :key="option.handle">
                                                                        <optgroup x-bind:label="option.name">
                                                                            <option
                                                                                x-bind:value="option.handle"
                                                                                x-text="option.handle"
                                                                            ></option>
                                                                        </optgroup>
                                                                    </template>
                                                                </select>
                                                            </template>
                                                        </div>
                                                        <div class="config-kind" x-text="config.value_kind"></div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Child namespaces -->
                                            <template x-for="childNamespace in namespace.children" :key="childNamespace.path">
                                                <div class="namespace-child">
                                                    <div 
                                                        class="namespace-header clickable"
                                                        @click="toggleNamespaceExpansion(childNamespace)"
                                                    >
                                                        <span x-text="childNamespace.isExpanded ? '‚ñº' : '‚ñ∂'"></span>
                                                        <strong x-text="childNamespace.name"></strong>
                                                        <span class="item-count" x-text="`(${childNamespace.items.length} items)`"></span>
                                                    </div>
                                                    
                                                    <div x-show="childNamespace.isExpanded" class="namespace-content">
                                                        <template x-for="config in childNamespace.items" :key="config.handle">
                                                            <div 
                                                                class="config-item"
                                                                x-show="!machineConfigHandleFilter || config.handle.toLowerCase().includes(machineConfigHandleFilter.toLowerCase())"
                                                            >
                                                                <div class="config-row">
                                                                    <div class="config-frozen">
                                                                        <input
                                                                            x-bind:id="`machineconfig-${config.handle}-frozen`"
                                                                            type="checkbox"
                                                                            x-model.boolean="config.frozen"
                                                                            x-init="disableElement($el,()=>(config.frozen||config.value_kind=='action'))"
                                                                        />
                                                                    </div>
                                                                    <div class="config-info">
                                                                        <label
                                                                            x-bind:for="`machineconfig-${config.handle}-frozen`"
                                                                            class="config-handle"
                                                                            x-text="config.handle"
                                                                        ></label>
                                                                        <div class="config-name" x-text="config.name"></div>
                                                                    </div>
                                                                    <div class="config-value">
                                                                        <template x-if="config.value_kind=='int'">
                                                                            <input
                                                                                type="number"
                                                                                step="1"
                                                                                x-model.number="config.value"
                                                                                is="number-input"
                                                                                x-init="registerNumberInput($el)"
                                                                                x-effect="disableElement($el,()=>config.frozen)"
                                                                            />
                                                                        </template>
                                                                        <template x-if="config.value_kind=='float'">
                                                                            <input
                                                                                type="number"
                                                                                step="0.01"
                                                                                x-model.number="config.value"
                                                                                is="number-input"
                                                                                x-init="registerNumberInput($el)"
                                                                                x-effect="disableElement($el,()=>config.frozen)"
                                                                            />
                                                                        </template>
                                                                        <template x-if="config.value_kind=='text'">
                                                                            <textarea
                                                                                rows="2"
                                                                                wrap="soft"
                                                                                x-model="config.value"
                                                                                x-effect="disableElement($el,()=>config.frozen)"
                                                                            ></textarea>
                                                                        </template>
                                                                        <template x-if="config.value_kind=='action'">
                                                                            <button
                                                                                x-text="config.value"
                                                                                @click="await runMachineConfigAction(config)"
                                                                            ></button>
                                                                        </template>
                                                                        <template x-if="config.value_kind=='option'">
                                                                            <select
                                                                                x-model="config.value"
                                                                                x-init="$el.value=config.value"
                                                                                x-effect="disableElement($el,()=>config.frozen)"
                                                                            >
                                                                                <template x-for="option in config.options" :key="option.handle">
                                                                                    <optgroup x-bind:label="option.name">
                                                                                        <option
                                                                                            x-bind:value="option.handle"
                                                                                            x-text="option.handle"
                                                                                        ></option>
                                                                                    </optgroup>
                                                                                </template>
                                                                            </select>
                                                                        </template>
                                                                    </div>
                                                                    <div class="config-kind" x-text="config.value_kind"></div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <!-- Fallback flat table view -->
                            <table x-show="!machineConfigUseNamespaces">
                                <tr>
                                    <th>frozen</th>
                                    <th>handle</th>
                                    <th>value</th>
                                    <th>kind</th>
                                    <th>name</th>
                                </tr>
                                <template
                                    x-for="config in filteredMachineConfig"
                                    :key="config.handle"
                                >
                                    <tr>
                                        <td>
                                            <input
                                                x-bind:id="`machineconfig-${config.handle}-frozen`"
                                                type="checkbox"
                                                x-model.boolean="config.frozen"
                                                x-init="disableElement($el,()=>(config.frozen||config.value_kind=='action'))"
                                            />
                                        </td>
                                        <td>
                                            <label
                                                x-bind:for="`machineconfig-${config.handle}-frozen`"
                                                x-text="config.handle"
                                            ></label>
                                        </td>
                                        <td>
                                            <template x-if="config.value_kind=='int'">
                                                <input
                                                    type="number"
                                                    step="1"
                                                    x-model.number="config.value"
                                                    is="number-input"
                                                    x-init="registerNumberInput($el)"
                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                />
                                            </template>
                                            <template x-if="config.value_kind=='float'">
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    x-model.number="config.value"
                                                    is="number-input"
                                                    x-init="registerNumberInput($el)"
                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                />
                                            </template>
                                            <template x-if="config.value_kind=='text'">
                                                <textarea
                                                    rows="3"
                                                    wrap="soft"
                                                    x-model="config.value"
                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                ></textarea>
                                            </template>
                                            <template x-if="config.value_kind=='action'">
                                                <button
                                                    x-text="config.value"
                                                    @click="await runMachineConfigAction(config)"
                                                ></button>
                                            </template>
                                            <template x-if="config.value_kind=='option'">
                                                <select
                                                    x-model="config.value"
                                                    x-init="$el.value=config.value"
                                                    x-effect="disableElement($el,()=>config.frozen)"
                                                >
                                                    <template x-for="option in config.options" :key="option.handle">
                                                        <optgroup x-bind:label="option.name">
                                                            <option
                                                                x-bind:value="option.handle"
                                                                x-text="option.handle"
                                                            ></option>
                                                        </optgroup>
                                                    </template>
                                                </select>
                                            </template>
                                        </td>
                                        <td x-text="config.value_kind"></td>
                                        <td x-text="config.name"></td>
                                    </tr>
                                </template>
                            </table>
                        </div>
                        <div tabname="Advanced">
                            <div>
                                <label>num steps</label
                                ><input
                                    type="number"
                                    x-model.number="laserAutofocusDebug_numz"
                                    step="2"
                                    min="3"
                                    max="99"
                                />
                                <label>delta z [um]</label
                                ><input
                                    type="number"
                                    x-model.number="laserAutofocusDebug_totalz_um"
                                    step="10"
                                    min="20"
                                    max="500"
                                />
                                <button
                                    @click="buttons_laserAutofocusDebugMeasurement"
                                >
                                    measure
                                </button>

                                <div
                                    style="width: 100%"
                                    x-effect="updateLaserAutofocusDebugMeasurementDisplay($el)"
                                    x-init="initLaserAutofocusDebugMeasurementDisplay($el)"
                                ></div>

                                <div>
                                    <button
                                        @click="button_laserAutofocusGetLatestImage"
                                    >
                                        fetch laser autofocus image
                                    </button>
                                    <canvas
                                        style="width: 100%"
                                        x-init="latestLaserAutofocusImageCanvas=$el"
                                    ></canvas>
                                </div>
                            </div>
                        </div>
                        <div tabname="Settings">
                            <div class="section">
                                <div>Interface Settings</div>
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 1em; align-items: center;">
                                    <label for="tooltips-enabled-checkbox">Tooltips enabled:</label>
                                    <input
                                        id="tooltips-enabled-checkbox"
                                        type="checkbox"
                                        x-model.boolean="tooltipConfig.enabled"
                                        @change="saveInterfaceSettings()"
                                    />
                                    
                                    <label 
                                        for="tooltip-delay-input"
                                        x-bind:class="!tooltipConfig.enabled ? 'disabled' : ''"
                                    >
                                        Tooltip delay (ms):
                                    </label>
                                    <input
                                        id="tooltip-delay-input"
                                        type="number"
                                        min="0"
                                        max="2000"
                                        step="50"
                                        x-model.number="tooltipConfig.delayMs"
                                        is="number-input"
                                        x-init="registerNumberInput($el),enabletooltip($el)"
                                        x-bind:tooltip="`How long to wait before showing tooltips when hovering. Range: 0-2000ms (0 = instant, 400 = default)`"
                                        x-bind:disabled="!tooltipConfig.enabled"
                                        @input="saveInterfaceSettings()"
                                    />

                                    <label for="popup-hide-delay-input">Popup hide delay (ms):</label>
                                    <input
                                        id="popup-hide-delay-input"
                                        type="number"
                                        min="0"
                                        max="2000"
                                        step="50"
                                        x-model.number="interfaceSettings.popupHideDelayMs"
                                        is="number-input"
                                        x-init="registerNumberInput($el),enabletooltip($el)"
                                        x-bind:tooltip="`How long to wait before hiding popups after moving the mouse away. Range: 0-2000ms (0 = instant, 500 = default)`"
                                        @input="saveInterfaceSettings()"
                                    />

                                    <label for="busy-linger-input">Busy indicator linger (ms):</label>
                                    <input
                                        id="busy-linger-input"
                                        type="number"
                                        min="0"
                                        max="5000"
                                        step="100"
                                        x-model.number="busyLingerMs"
                                        is="number-input"
                                        x-init="registerNumberInput($el),enabletooltip($el)"
                                        x-bind:tooltip="`How long the busy indicator stays visible after microscope becomes available.`"
                                        @input="saveInterfaceSettings()"
                                    />

                                    <label>Theme:</label>
                                    <select
                                        x-model="theme"
                                        @change="changeTheme($el,$event)"
                                    >
                                        <template
                                            x-for="themeoption in themes"
                                            :key="themeoption"
                                        >
                                            <option
                                                x-bind:value="themeoption"
                                                x-text="themeoption"
                                                x-bind:selected="themeoption === theme"
                                            ></option>
                                        </template>
                                    </select>
                                </div>
                            </div>

                            <div class="section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
                                    <div>Cached Microscope Settings</div>
                                    <button
                                        @click="loadCachedMicroscopes()"
                                        x-bind:tooltip="`Reload the list of cached microscope configurations from localStorage`"
                                        style="padding: 0.5em 1em;"
                                    >
                                        Refresh
                                    </button>
                                </div>
                                <template x-if="cachedMicroscopes.length === 0">
                                    <div style="color: var(--muted-text-color); font-style: italic;">
                                        No cached microscope configurations found.
                                    </div>
                                </template>
                                <template x-if="cachedMicroscopes.length > 0">
                                    <div style="display: flex; flex-direction: column; gap: 0.4em;">
                                        <template
                                            x-for="microscopeName in cachedMicroscopes"
                                            :key="microscopeName"
                                        >
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4em; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--bg-color);">
                                                <div style="word-break: break-word;">
                                                    <strong x-text="microscopeName"></strong>
                                                </div>
                                                <button
                                                    @click="deleteCachedMicroscope(microscopeName)"
                                                    x-bind:tooltip="`Delete cached configuration for ${microscopeName}`"
                                                    class="cached-microscope-delete-button"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    #acquisitioncontroltab,
                    #machineconfigtab {
                        height: 100%;
                        overflow-y: auto;
                    }
                </style>
                <div id="rightcol" style="grid-area: b">
                    <div x-init="initTabs($el)">
                        <div
                            id="acquisitioncontroltab"
                            tabname="Acquisition Control"
                        >
                            <div class="section">
                                <div>Acquisition Basics</div>
                                <div>
                                    <div id="names" class="scrolly">
                                        <style>
                                            #names {
                                                display: grid;
                                                grid-template:
                                                    " l-proj  v-proj" auto
                                                    " l-plate v-plate" auto
                                                    " l-cell  v-cell" auto
                                                    / auto 1fr;
                                                gap: 0.3em 1em;
                                            }
                                        </style>
                                        <label> Project Name</label
                                        ><input
                                            type="text"
                                            placeholder="Name of the project"
                                            x-model="microscope_config.project_name"
                                        />
                                        <label> Plate Name</label
                                        ><input
                                            type="text"
                                            placeholder="Name/Identifier of the plate"
                                            x-model="microscope_config.plate_name"
                                        />
                                        <label> Cell Line[s]</label
                                        ><input
                                            type="text"
                                            placeholder="Cell lines[s] used on the plate"
                                            x-model="microscope_config.cell_line"
                                        />
                                        <label> Comment</label
                                        ><textarea
                                            placeholder="description of the plate to understand its purpose."
                                            x-model="microscope_config.comment"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <div>Site Configuration</div>
                                <div>
                                    <div id="grid-config" class="scrolly">
                                        <style>
                                            #grid-config {
                                                display: grid;
                                                grid-template:
                                                    " l-n-x       v-n-x l-d-x       v-d-x   v-d-x   v-d-x   v-d-x   v-d-x   v-d-x" auto
                                                    " l-n-y       v-n-y l-d-y       v-d-y   v-d-y   v-d-y   v-d-y   v-d-y   v-d-y" auto
                                                    " l-n-t       v-n-t l-d-t       l-d-t-h v-d-t-h l-d-t-m v-d-t-m l-d-t-s v-d-t-s" auto
                                                    / auto auto auto auto auto auto auto auto auto;
                                                gap: 0.3em 1em;

                                                label {
                                                    height: min-content;
                                                    width: max-content;
                                                }
                                            }
                                        </style>
                                        <label style="grid-area: l-n-x"
                                            >num x</label
                                        >
                                        <input
                                            style="grid-area: v-n-x"
                                            type="number"
                                            min="1"
                                            max="999"
                                            step="1"
                                            @change="updatePlate"
                                            x-model.number="microscope_config.grid.num_x"
                                        />

                                        <label style="grid-area: l-d-x"
                                            >delta x [mm]</label
                                        >
                                        <input
                                            style="grid-area: v-d-x"
                                            x-effect="disableElement($el,()=>microscope_config.grid.num_x==1)"
                                            type="number"
                                            min="0.1"
                                            max="999"
                                            step="0.1"
                                            @change="updatePlate"
                                            x-model.number="microscope_config.grid.delta_x_mm"
                                        />

                                        <label style="grid-area: l-n-y"
                                            >num y</label
                                        >
                                        <input
                                            style="grid-area: v-n-y"
                                            type="number"
                                            min="1"
                                            max="999"
                                            step="1"
                                            @change="updatePlate"
                                            x-model.number="microscope_config.grid.num_y"
                                        />

                                        <label style="grid-area: l-d-y"
                                            >delta y [mm]</label
                                        >
                                        <input
                                            style="grid-area: v-d-y"
                                            x-effect="disableElement($el,()=>microscope_config.grid.num_y==1)"
                                            type="number"
                                            min="0.1"
                                            max="999"
                                            step="0.1"
                                            @change="updatePlate"
                                            x-model.number="microscope_config.grid.delta_y_mm"
                                        />

                                        <label style="grid-area: l-n-t"
                                            >num t</label
                                        >
                                        <input
                                            style="grid-area: v-n-t"
                                            type="number"
                                            min="1"
                                            max="9999"
                                            step="1"
                                            @change="updatePlate"
                                            x-model.number="microscope_config.grid.num_t"
                                        />

                                        <label style="grid-area: l-d-t"
                                            >delta t</label
                                        >
                                        <label style="grid-area: l-d-t-h"
                                            >h</label
                                        >
                                        <input
                                            x-effect="disableElement($el,()=>microscope_config.grid.num_t==1)"
                                            style="grid-area: v-d-t-h"
                                            type.number="number"
                                            min="0"
                                            max="999"
                                            step="0.1"
                                            @change="updatePlate"
                                            x-model="microscope_config.grid.delta_t.h"
                                        />
                                        <label style="grid-area: l-d-t-m"
                                            >m</label
                                        >
                                        <input
                                            x-effect="disableElement($el,()=>microscope_config.grid.num_t==1)"
                                            style="grid-area: v-d-t-m"
                                            type.number="number"
                                            min="0"
                                            max="59.9"
                                            step="0.1"
                                            @change="updatePlate"
                                            x-model="microscope_config.grid.delta_t.m"
                                        />
                                        <label style="grid-area: l-d-t-s"
                                            >s</label
                                        >
                                        <input
                                            x-effect="disableElement($el,()=>microscope_config.grid.num_t==1)"
                                            style="grid-area: v-d-t-s"
                                            type.number="number"
                                            min="0"
                                            max="59.9"
                                            step="0.1"
                                            @change="updatePlate"
                                            x-model="microscope_config.grid.delta_t.s"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <div>Wellplate Configuration</div>
                                <div>
                                    <div id="well-selector" class="scrolly">
                                        <style>
                                            #well-selector {
                                                display: grid;
                                                grid-template: "p" auto "w" auto / auto;
                                                gap: 0.3em;
                                            }
                                        </style>
                                        <script>
                                            function checkDefaultPlateType(
                                                el,
                                                plate,
                                                microscope_config,
                                            ) {
                                                if (
                                                    plate.Model_id ==
                                                    microscope_config
                                                        .wellplate_type.Model_id
                                                ) {
                                                    el.setAttribute(
                                                        "selected",
                                                        "",
                                                    );
                                                }
                                            }
                                        </script>

                                        <div id="plate-type-selector">
                                            <style>
                                                #plate-type-selector {
                                                    display: grid;
                                                    grid-template: "l s" auto / auto 1fr;
                                                    gap: 0.3em;
                                                }
                                            </style>
                                            <label>Well plate Type</label>
                                            <select
                                                id="platetype"
                                                @change="await updatePlate($el.value)"
                                                x-init="await updatePlate(microscope_config.wellplate_type.Model_id,false)"
                                            >
                                                <template
                                                    x-for="plategroup in plateinfo.plategroups"
                                                    :key="plategroup.label"
                                                >
                                                    <optgroup
                                                        x-bind:label="plategroup.label"
                                                    >
                                                        <template
                                                            x-for="plate in plategroup.plates"
                                                            :key="plate.Model_id"
                                                        >
                                                            <option
                                                                x-init="checkDefaultPlateType($el,plate,microscope_config)"
                                                                x-bind:value="plate.Model_id"
                                                                x-text="`${plate.Manufacturer} ${plate.Model_id_manufacturer} ( ${plate.Model_name} )`"
                                                            ></option>
                                                        </template>
                                                    </optgroup>
                                                </template>
                                            </select>
                                        </div>

                                        <style>
                                            /* 1 slide holder */
                                            #wellcontainer.wellsx1,
    									/* 4 slide holder */
    									#wellcontainer.wellsx4 {
                                                .well {
                                                    font-size: 2em;
                                                }
                                            }
                                            /* 96 well plate */
                                            #wellcontainer.wellsx12 {
                                                .well {
                                                    font-size: 1.5em;
                                                }
                                            }
                                            /* 384 well plate */
                                            #wellcontainer.wellsx24 {
                                                .well {
                                                    font-size: 1.2em;
                                                }
                                            }
                                            #wellcontainer.wellsx48 {
                                                .well {
                                                    font-size: 0.56em;
                                                }
                                            }
                                            #wellcontainer {
                                                display: grid;
                                                border: 1px solid
                                                    var(--text-color);

                                                /*first column is well header which can have any size, all other wells must have equal size*/
                                                grid-template-columns: auto repeat(
                                                        var(--numcols),
                                                        1fr
                                                    );

                                                .well {
                                                    font-family: monospace;
                                                }

                                                .well:not(.wellheader) {
                                                    aspect-ratio: var(
                                                        --well-aspect-ratio
                                                    );
                                                }

                                                .well.selected {
                                                    background: var(
                                                        --highlight-color
                                                    );
                                                }

                                                .well:hover:not(.wellheader) {
                                                    background: lightgrey;
                                                }
                                            }
                                        </style>
                                        <div
                                            id="wellcontainer"
                                            x-bind:class="`wellsx${microscope_config.wellplate_type.Num_wells_x}`"
                                            x-bind:style="`
									--numcols:${microscope_config.wellplate_type.Num_wells_x};
									--well-aspect-ratio:${microscope_config.wellplate_type.Well_size_x_mm/microscope_config.wellplate_type.Well_size_y_mm}
									`"
                                            @mouseleave="endSelectionRange(null)"
                                        >
                                            <style>
                                                .well {
                                                    display: grid;
                                                    justify-items: center;
                                                    span {
                                                        height: min-content;
                                                        display: inline-block;
                                                        position: relative;
                                                        top: 50%;
                                                        transform: translateY(
                                                            -50%
                                                        );
                                                    }
                                                }
                                                .inselection {
                                                    background: red;
                                                }
                                            </style>
                                            <!-- Column headers (row = -1) -->
                                            <template
                                                x-for="well in createHeaderWells(microscope_config.wellplate_type).filter(w => w.row === -1)"
                                                :key="`header-c${well.col}r${well.row}`"
                                            >
                                                <div
                                                    class="well noselect wellheader"
                                                    x-bind:style="`grid-column: ${well.col + 2}; grid-row: 1;`"
                                                >
                                                    <span x-text="wellText(well)"></span>
                                                </div>
                                            </template>
                                            
                                            <!-- Row headers (col = -1) -->
                                            <template
                                                x-for="well in createHeaderWells(microscope_config.wellplate_type).filter(w => w.col === -1)"
                                                :key="`header-c${well.col}r${well.row}`"
                                            >
                                                <div
                                                    class="well noselect wellheader"
                                                    x-bind:style="`grid-column: 1; grid-row: ${well.row + 2};`"
                                                >
                                                    <span x-text="wellText(well)"></span>
                                                </div>
                                            </template>
                                            
                                            <!-- Real wells (col >= 0 and row >= 0) -->
                                            <template
                                                x-for="well in microscope_config.plate_wells.filter(w => w.col >= 0 && w.row >= 0)"
                                                :key="`well-c${well.col}r${well.row}`"
                                            >
                                                <div
                                                    x-init="enabletooltip($el)"
                                                    x-bind:tooltip="`Well ${wellName(well)}`"
                                                    class="well noselect clickable"
                                                    x-bind:class="well.selected ? 'selected' : ''"
                                                    x-bind:style="`grid-column: ${well.col + 2}; grid-row: ${well.row + 2};`"
                                                    @mousedown="setStartSelectedWell(event,well)"
                                                    @mouseenter="selectionContinue(event,well)"
                                                    @mouseup="endSelectionRange(well)"
                                                    @dblclick="await buttons_wellcontainer_dblclick(well)"
                                                >
                                                    <span></span>
                                                </div>
                                            </template>
                                        </div>
                                        <div x-text="selectionRangeText"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div tabname="Lighting and Focus">
                            <div class="section">
                                <div>Channel Configuration</div>
                                <div>
                                    <div id="channelgrid" class="scrolly">
                                        <style>
                                            #channelgrid {
                                                display: grid;
                                                grid-template-columns:
                                                    2em /* drag handle */
                                                    repeat(3, max-content)
                                                    5em 5em 5em 5em 4em 7em 8em;

                                                .channel-config-header {
                                                    text-align: center;
                                                }

                                                /* x padding here is present inside the row container, but y padding
                                                is NOT, so y padding is added inside the row container instead*/
                                                gap: 0 0.4em;

                                                .channel-config-row-name {
                                                    font-weight: bold;
                                                    display: grid;
                                                    align-items: center;

                                                    background: var(
                                                        --weak-bg-color
                                                    );
                                                    padding-right: 0.5em;
                                                    border-right: 1px solid
                                                        var(--text-color);
                                                }
                                            }
                                            .drag-handle {
                                                cursor: grab;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                font-size: 1.2em;
                                                user-select: none;
                                                color: var(--text-color);
                                                opacity: 0.6;
                                                transition: opacity 0.2s ease;
                                                padding: 0.2em;
                                                border-radius: 3px;
                                            }
                                            .drag-handle:hover {
                                                opacity: 1;
                                                background-color: var(--weak-bg-color);
                                            }
                                            .drag-handle:active {
                                                cursor: grabbing;
                                                background-color: var(--highlight-color);
                                            }
                                            .channel-config-row-container.dragging {
                                                opacity: 0.5;
                                            }
                                            .channel-config-row-container.drag-over {
                                                border-top: 3px solid var(--highlight-color);
                                            }
                                        </style>

                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            x-bind:tooltip="`Drag to reorder channels (changes protocol_order)`"
                                        >
                                            ‚Üï
                                        </p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            x-bind:tooltip="`
    										Indicates if the channel should be imaged during acqusition.

    										When checked, this channel will be imaged.
    									`"
                                        >
                                            ?
                                        </p>
                                        <p
                                            class="channel-config-header channel-config-row-name"
                                        >
                                            Channel
                                        </p>
                                        <p class="channel-config-header"></p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            tooltip="Exposure time in milliseconds. Hover over individual inputs for specific ranges."
                                        >
                                            Exp. [ms]
                                        </p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            tooltip="Analog gain in decibels. Hover over individual inputs for specific ranges."
                                        >
                                            Gain [dB]
                                        </p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            tooltip="Z offset from focus reference in micrometers. Hover over individual inputs for specific ranges."
                                        >
                                            Off. [um]
                                        </p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            tooltip="Illumination strength as percent of maximum. Limits vary by channel type - hover over individual inputs for specific ranges."
                                        >
                                            Pow. [%]
                                        </p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            tooltip="Number of Z planes. Hover over individual inputs for specific ranges."
                                        >
                                            num z
                                        </p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            tooltip="Distance between Z planes in micrometers. Hover over individual inputs for specific ranges."
                                        >
                                            delta z [um]
                                        </p>
                                        <p
                                            class="channel-config-header"
                                            x-init="enabletooltip($el)"
                                            x-bind:tooltip="`
    										Filter wheel selection for this channel.

    										Select 'None' for no filter movement, or choose a specific filter to position the filter wheel before imaging.
    										`"
                                        >
                                            Filter
                                        </p>

                                        <style>
                                            .channel-config-row-container {
                                                background: var(
                                                    --strong-bg-color
                                                );

                                                display: grid;
                                                grid-column: 1 / -1; /* span full width of parent grid */
                                                grid-template-columns: subgrid; /* inherit columns from .parent */
                                                grid-template-rows: subgrid; /* inherit rows from .parent */
                                                gap: inherit;
                                                /* see #channelgrid for comment on padding */
                                                padding: 0.2em 0;

                                                * {
                                                    box-sizing: content-box;
                                                }
                                            }
                                            .channel-config-row-container:hover {
                                                background: lightcoral;
                                            }
                                            .channel-config-row-name {
                                                /* stretch label to full row height*/
                                                display: block;
                                                height: 100%;

                                                /* make it stick to the left edge while scrolling, to always be visible */
                                                position: sticky;
                                                left: 0;

                                                /* inherit background color from parent (would otherwise be transparent and mess with position:sticky; display */
                                                background: inherit;
                                            }
                                        </style>

                                        <template
                                            x-for="(channel, index) in microscope_config.channels"
                                            :key="channel.handle"
                                        >
                                            <div
                                                class="channel-config-row-container"
                                                @dragover="handleChannelDragOver($event)"
                                                @drop="handleChannelDrop($event, index)"
                                                @dragenter="handleChannelDragEnter($event)"
                                                @dragleave="handleChannelDragLeave($event)"
                                            >
                                                <div
                                                    class="drag-handle"
                                                    draggable="true"
                                                    @dragstart="startChannelDrag($event, index)"
                                                    @dragend="endChannelDrag($event)"
                                                    x-init="enabletooltip($el)"
                                                    x-bind:tooltip="`Drag to reorder this channel`"
                                                >
                                                    ‚Üï
                                                </div>
                                                <input
                                                    x-bind:id="`${channel.handle}-enabled`"
                                                    type="checkbox"
                                                    x-model.boolean="channel.enabled"
                                                />
                                                <div
                                                    class="channel-config-row-name"
                                                >
                                                    <label
                                                        x-bind:for="`${channel.handle}-enabled`"
                                                        x-text="channel.name"
                                                        x-effect="disableElement($el,()=>!channel.enabled)"
                                                    ></label>
                                                </div>
                                                <button
                                                    @click="Actions.snapChannel({channel})"
                                                    @mouseenter="channel_makeVisible(channel.handle);"
                                                    x-effect="disableElement($el,()=>!channel.enabled)"
                                                >
                                                    snap
                                                </button>

                                                <input
                                                    type="number"
                                                    x-bind:min="limits.imaging_exposure_time_ms.min"
                                                    x-bind:step="limits.imaging_exposure_time_ms.step"
                                                    x-bind:max="limits.imaging_exposure_time_ms.max"
                                                    placeholder="5"
                                                    x-model.number="channel.exposure_time_ms"
                                                    x-init="registerNumberInput($el),enabletooltip($el)"
                                                    x-bind:tooltip="`Exposure time: ${limits.imaging_exposure_time_ms?.min ?? 'N/A'}ms - ${limits.imaging_exposure_time_ms?.max ?? 'N/A'}ms (step: ${limits.imaging_exposure_time_ms?.step ?? 'N/A'}ms)`"
                                                    is="number-input"
                                                    x-effect="disableElement($el,()=>!channel.enabled)"
                                                />

                                                <input
                                                    type="number"
                                                    x-bind:min="limits.imaging_analog_gain_db.min"
                                                    x-bind:step="limits.imaging_analog_gain_db.step"
                                                    x-bind:max="limits.imaging_analog_gain_db.max"
                                                    placeholder="0"
                                                    x-model.number="channel.analog_gain"
                                                    x-init="registerNumberInput($el),enabletooltip($el)"
                                                    x-bind:tooltip="`Analog gain: ${limits.imaging_analog_gain_db?.min ?? 'N/A'}dB - ${limits.imaging_analog_gain_db?.max ?? 'N/A'}dB (step: ${limits.imaging_analog_gain_db?.step ?? 'N/A'}dB)`"
                                                    is="number-input"
                                                    x-effect="disableElement($el,()=>!channel.enabled)"
                                                />

                                                <input
                                                    type="number"
                                                    x-bind:min="limits.imaging_focus_offset_um.min"
                                                    x-bind:step="limits.imaging_focus_offset_um.step"
                                                    x-bind:max="limits.imaging_focus_offset_um.max"
                                                    placeholder="0"
                                                    x-model.number="channel.z_offset_um"
                                                    x-init="registerNumberInput($el),enabletooltip($el)"
                                                    x-bind:tooltip="`Z offset: ${limits.imaging_focus_offset_um?.min ?? 'N/A'}Œºm - ${limits.imaging_focus_offset_um?.max ?? 'N/A'}Œºm (step: ${limits.imaging_focus_offset_um?.step ?? 'N/A'}Œºm)`"
                                                    is="number-input"
                                                    x-effect="disableElement($el,()=>!channel.enabled)"
                                                />

                                                <input
                                                    type="number"
                                                    x-bind:min="channel.handle.startsWith('bfled') ? (limits.imaging_illum_perc_brightfield?.min || limits.imaging_illum_perc?.min) : (limits.imaging_illum_perc_fluorescence?.min || limits.imaging_illum_perc?.min)"
                                                    x-bind:step="channel.handle.startsWith('bfled') ? (limits.imaging_illum_perc_brightfield?.step || limits.imaging_illum_perc?.step) : (limits.imaging_illum_perc_fluorescence?.step || limits.imaging_illum_perc?.step)"
                                                    x-bind:max="channel.handle.startsWith('bfled') ? (limits.imaging_illum_perc_brightfield?.max || limits.imaging_illum_perc?.max) : (limits.imaging_illum_perc_fluorescence?.max || limits.imaging_illum_perc?.max)"
                                                    placeholder="100"
                                                    x-model.number="channel.illum_perc"
                                                    is="number-input"
                                                    x-init="registerNumberInput($el),$nextTick(()=>$dispatch('blur')),enabletooltip($el)"
                                                    x-bind:tooltip="channel.handle.startsWith('bfled') ? `Brightfield LED power: ${limits.imaging_illum_perc_brightfield?.min ?? limits.imaging_illum_perc?.min ?? 'N/A'}% - ${limits.imaging_illum_perc_brightfield?.max ?? limits.imaging_illum_perc?.max ?? 'N/A'}% (step: ${limits.imaging_illum_perc_brightfield?.step ?? limits.imaging_illum_perc?.step ?? 'N/A'}%)` : `Fluorescence LED power: ${limits.imaging_illum_perc_fluorescence?.min ?? limits.imaging_illum_perc?.min ?? 'N/A'}% - ${limits.imaging_illum_perc_fluorescence?.max ?? limits.imaging_illum_perc?.max ?? 'N/A'}% (step: ${limits.imaging_illum_perc_fluorescence?.step ?? limits.imaging_illum_perc?.step ?? 'N/A'}%)`"
                                                    x-effect="disableElement($el,()=>!channel.enabled)"
                                                />

                                                <input
                                                    type="number"
                                                    x-bind:min="limits.imaging_number_z_planes.min"
                                                    x-bind:step="limits.imaging_number_z_planes.step"
                                                    x-bind:max="limits.imaging_number_z_planes.max"
                                                    placeholder="1"
                                                    x-model.number="channel.num_z_planes"
                                                    is="number-input"
                                                    x-init="registerNumberInput($el),enabletooltip($el)"
                                                    x-bind:tooltip="`Number of Z planes: ${limits.imaging_number_z_planes?.min ?? 'N/A'} - ${limits.imaging_number_z_planes?.max ?? 'N/A'} (step: ${limits.imaging_number_z_planes?.step ?? 'N/A'})`"
                                                    x-effect="disableElement($el,()=>!channel.enabled)"
                                                />

                                                <input
                                                    type="number"
                                                    x-bind:min="limits.imaging_delta_z_um.min"
                                                    x-bind:step="limits.imaging_delta_z_um.step"
                                                    x-bind:max="limits.imaging_delta_z_um.max"
                                                    placeholder="3"
                                                    x-model.number="channel.delta_z_um"
                                                    is="number-input"
                                                    x-init="registerNumberInput($el),enabletooltip($el)"
                                                    x-bind:tooltip="`Delta Z spacing: ${limits.imaging_delta_z_um?.min ?? 'N/A'}Œºm - ${limits.imaging_delta_z_um?.max ?? 'N/A'}Œºm (step: ${limits.imaging_delta_z_um?.step ?? 'N/A'}Œºm)`"
                                                    x-effect="disableElement($el,()=>!channel.enabled)"
                                                />

                                                <select
                                                    @change="channel.filter_handle = ($event.target.value === '__UI_NONE__' ? null : $event.target.value)"
                                                    x-effect="disableElement($el,()=>!channel.enabled || !isFilterWheelAvailable); setupFilterValidation($el, channel, isFilterWheelAvailable)"
                                                    x-init="enabletooltip($el)"
                                                    x-bind:tooltip="!isFilterWheelAvailable ? 'This microscope does not support custom channel filters.' : ''"
                                                >
                                                    <template
                                                        x-for="filterOption in filterOptions.filter(f => !f.isGroup)"
                                                        :key="filterOption.handle"
                                                    >
                                                        <option
                                                            x-bind:value="filterOption.handle"
                                                            x-bind:selected="filterOption.handle === (channel.filter_handle ?? '__UI_NONE__')"
                                                            x-text="filterOption.name"
                                                        ></option>
                                                    </template>
                                                    <template
                                                        x-for="filterOption in filterOptions.filter(f => f.isGroup)"
                                                        :key="filterOption.handle"
                                                    >
                                                        <optgroup x-bind:label="filterOption.groupLabel">
                                                            <option
                                                                x-bind:value="filterOption.handle"
                                                                x-bind:selected="filterOption.handle === (channel.filter_handle ?? '__UI_NONE__')"
                                                                x-text="filterOption.name"
                                                            ></option>
                                                        </optgroup>
                                                    </template>
                                                </select>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <div>Quick Capture</div>
                                <div>
                                    <button 
                                        @click="Actions.snapAllChannels()"
                                        x-init="enabletooltip($el)"
                                        x-bind:tooltip="`
                                            Snap all enabled channels with their configured settings.
                                            
                                            This will:
                                            ‚Ä¢ Run laser autofocus if enabled and calibrated
                                            ‚Ä¢ Move to each channel's Z-offset
                                            ‚Ä¢ Capture images with the configured exposure and gain
                                            ‚Ä¢ Display captured images
                                        `"
                                    >
                                        Snap All Channels
                                    </button>
                                </div>
                            </div>

                            <div class="section">
                                <div>
                                    Live Acquisition
                                    <span 
                                        x-show="isStreaming" 
                                        class="streaming-indicator"
                                        x-transition.opacity.duration.300ms
                                    >
                                        ‚óè STREAMING
                                    </span>
                                </div>
                                <div>
                                    <div
                                        id="live-acquisition-controls"
                                        class="scrolly"
                                    >
                                        <style>
                                            #live-acquisition-controls {
                                                display: grid;
                                                grid-template-columns: repeat(
                                                    4,
                                                    auto
                                                );
                                                gap: 0 0.6em;
                                            }
                                            
                                            .streaming-indicator {
                                                color: #ff4444;
                                                font-weight: bold;
                                                font-size: 0.9em;
                                                margin-left: 10px;
                                                animation: pulse 1.5s infinite;
                                                text-shadow: 0 0 4px rgba(255, 68, 68, 0.6);
                                            }
                                            
                                            @keyframes pulse {
                                                0%, 100% { opacity: 1; }
                                                50% { opacity: 0.6; }
                                            }
                                        </style>

                                        <label
                                            x-init="enabletooltip($el)"
                                            x-bind:tooltip="`
										Live Acquisition controls.

										Live Acquisition is the process where a number of acquisition are performed each second until stopped.

										Note that this may quickly bleach your sample!
									`"
                                            >Live Acq.</label
                                        >
                                        <button 
                                            @click="buttons_startStreaming"
                                            :disabled="isStreaming"
                                        >
                                            start
                                        </button>
                                        <button 
                                            @click="buttons_endStreaming"
                                            :disabled="!isStreaming"
                                        >
                                            stop
                                        </button>
                                        <select
                                            id="live-channel-selection"
                                            x-model="actionInput.live_acquisition_channelhandle"
                                            x-init="$nextTick(()=>{actionInput.live_acquisition_channelhandle = $el.value})"
                                        >
                                            <optgroup label="Fluorescence">
                                                <template
                                                    x-for="channel in microscope_config.channels"
                                                    :key="channel.handle"
                                                >
                                                    <template
                                                        x-if="channel.enabled && channel.handle[0]=='f'"
                                                    >
                                                        <option
                                                            x-bind:value="channel.handle"
                                                            x-text="channel.name"
                                                        ></option>
                                                    </template>
                                                </template>
                                            </optgroup>
                                            <optgroup label="Brightfield">
                                                <template
                                                    x-for="channel in microscope_config.channels"
                                                    :key="channel.handle"
                                                >
                                                    <template
                                                        x-if="channel.enabled && channel.handle[0]=='b'"
                                                    >
                                                        <option
                                                            x-bind:value="channel.handle"
                                                            x-text="channel.name"
                                                        ></option>
                                                    </template>
                                                </template>
                                            </optgroup>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <div>Laser Autofocus</div>
                                <div>
                                    <div
                                        id="laser-autofocus-controls"
                                        class="scrolly"
                                    >
                                        <style>
                                            #laser-autofocus-controls {
                                                display: grid;
                                                grid-template-columns: repeat(
                                                    3,
                                                    auto
                                                );
                                                gap: 0.3em;
                                            }
                                        </style>
                                        <label>Reference</label>
                                        <span
                                            x-text="laserAutofocusReferenceText"
                                        ></span>
                                        <button
                                            x-init="enabletooltip($el)"
                                            x-bind:tooltip="`calibrate laser autofocus here, i.e. retain this level of focus on the cells.`"
                                            @click="buttons_calibrateLaserAutofocusHere"
                                        >
                                            Set here
                                        </button>

                                        <label
                                            >Offset from reference [um]</label
                                        >
                                        <span
                                            x-text="laserAutofocusOffsetText"
                                        ></span>
                                        <button
                                            @click="button_laserAutofocusMeasureOffset"
                                        >
                                            Measure
                                        </button>

                                        <label
                                            x-init="enabletooltip($el)"
                                            tooltip="target offset from reference."
                                            >Target Offset [um]</label
                                        >
                                        <input
                                            type="number"
                                            x-model.number="laserAutofocusTargetOffsetUM"
                                        />
                                        <button
                                            @click="button_laserAutofocusMoveToTargetOffset"
                                        >
                                            Move
                                        </button>

                                        <label
                                            x-init="enabletooltip($el)"
                                            x-bind:tooltip="`Enable autofocus during acquisition. Only available when reference is calibrated (non-zero).`"
                                            >Use during acquisition</label
                                        >
                                        <input
                                            type="checkbox"
                                            x-model="microscope_config.autofocus_enabled"
                                            x-bind:disabled="laserAutofocusReferenceValue == 0"
                                        />
                                        <span
                                            x-show="laserAutofocusReferenceValue == 0"
                                            style="color: #888; font-size: 0.9em;"
                                        >
                                            Set reference first
                                        </span>
                                        <span
                                            x-show="laserAutofocusReferenceValue != 0"
                                            x-text="microscope_config.autofocus_enabled ? 'Enabled' : 'Disabled'"
                                        ></span>
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <div>Histogram</div>
                                <div
                                    style="width: 100%"
                                    x-init="makeHistogram($el)"
                                    x-effect="updateHistogram($el)"
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="bottom-bar">
                    <style>
                        #bottom-bar {
                            border-top: 1px solid var(--text-color);
                            grid-area: f;
                            min-height: 4em;

                            gap: 0 0.3em;
                            display: grid;
                            grid-template:
                                "server stage acquisition" 1fr
                                / min-content min-content 1fr;
                        }
                        .stage-coords {
                            font-family: monospace;
                            font-size: 0.9em;
                            white-space: nowrap;
                        }
                        .bottom-section {
                            padding: 0.5em;
                            border-radius: 0.3em;
                            background: var(--weak-bg-color);
                            border: 1px solid var(--highlight-color);
                            margin: 0.1em;
                        }
                    </style>
                    
                    <!-- Server Connection Status -->
                    <div class="bottom-section" style="grid-area: server; display: flex; align-items: center;" x-init="registerContainedPopup($el)">
                        <style>
                            .connection-indicator {
                                display: inline-block;
                                aspect-ratio: 1/1;
                                height: 1.2em;
                                border-radius: 50%;
                                margin-left: 0.5em;
                            }
                            .connection-indicator.connected {
                                background-color: #2ace1b;
                            }
                            .connection-indicator:not(.connected) {
                                background-color: #e74c3c;
                            }
                        </style>
                        <span x-text="isConnectedToServer ? 'Connected' : 'Disconnected'"></span>
                        <span
                            x-bind:class="`connection-indicator ${isConnectedToServer?'connected':''}`"
                            >&nbsp;</span
                        >
                        
                        <!-- Server Details Popup -->
                        <div class="popup">
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5em; align-items: center;">
                                <label>Server URL:</label>
                                <input
                                    type="text"
                                    x-model="server_url_input"
                                    @keydown="(ev)=>{if(ev.key=='Enter'){$dispatch('blur')}}"
                                    x-init="$nextTick(()=>{server_url_input=server_url;$dispatch('blur')})"
                                    @blur="status_reconnect(server_url_input)"
                                    style="width: 100%;"
                                />
                                <label>Microscope:</label>
                                <span x-text="getMachineConfigItem('system.microscope_name')?.value ?? '(none)'"></span>
                                <label>Status:</label>
                                <span x-text="isConnectedToServer ? 'Connected' : 'Disconnected'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Stage Position -->
                    <div class="bottom-section" style="grid-area: stage; display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 1em;" x-init="registerContainedPopup($el)">
                        <span>Stage</span>
                        <div style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 2px;">
                            <div class="stage-coords">X: <span x-html="formatStageCoordXY(state.adapter_state?.stage_position.x_pos_mm)"></span>mm</div>
                            <div class="stage-coords">Y: <span x-html="formatStageCoordXY(state.adapter_state?.stage_position.y_pos_mm)"></span>mm</div>
                            <div class="stage-coords">Z: <span x-html="formatStageCoordZ(state.adapter_state?.stage_position.z_pos_mm)"></span>Œºm</div>
                        </div>
                        
                        <!-- Stage Control Popup -->
                        <div class="popup">
                            <div style="display: grid; grid-template:
                                'lx vx mv ms llp' auto
                                'ly vy mp mp lpe' auto
                                'lz vz mm mm lpl' auto
                                / 1fr 1fr 1fr 1fr auto;
                                gap: 0 1em;">
                                
                                <span style="grid-area: lx">X [mm]</span>
                                <span style="grid-area: vx; font-family: monospace;" x-html="formatStageCoordXY(state.adapter_state?.stage_position.x_pos_mm)"></span>
                                <span style="grid-area: ly">Y [mm]</span>
                                <span style="grid-area: vy; font-family: monospace;" x-html="formatStageCoordXY(state.adapter_state?.stage_position.y_pos_mm)"></span>
                                <span style="grid-area: lz">Z [Œºm]</span>
                                <span style="grid-area: vz; font-family: monospace;" x-html="formatStageCoordZ(state.adapter_state?.stage_position.z_pos_mm)"></span>
                                
                                <input
                                    style="grid-area: mv"
                                    type="number"
                                    step="0.001"
                                    x-model.number="moveByDistance"
                                />
                                <select style="grid-area: ms" x-model="moveByAxis">
                                    <option value="x">X [mm]</option>
                                    <option value="y">Y [mm]</option>
                                    <option value="z" selected>Z [Œºm]</option>
                                </select>
                                <button style="grid-area: mp" @click="stageMoveBy('+')">+</button>
                                <button style="grid-area: mm" @click="stageMoveBy('-')">-</button>

                                <label style="grid-area: llp">Loading Position</label>
                                <button
                                    style="grid-area: lpe"
                                    x-effect="disableElement($el,()=>state?.adapter_state.is_in_loading_position??true)"
                                    @click="await Actions.enterLoadingPosition()"
                                >
                                    Enter
                                </button>
                                <button
                                    style="grid-area: lpl"
                                    x-effect="disableElement($el,()=>!(state?.adapter_state.is_in_loading_position??false))"
                                    @click="await Actions.leaveLoadingPosition()"
                                >
                                    Leave
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Acquisition Progress -->
                    <div class="bottom-section" style="grid-area: acquisition" id="acquisition-progress-container">
                        <style>
                            #acquisition-progress-container {
                                display: grid;
                                grid-template-columns: auto 1fr auto auto;
                            }
                            #acquisition-progress-bar {
                                margin: 0.2em;
                                padding: 0.4em;
                                border: 1px solid var(--text-color);
                                --progress-color: var(--highlight-color);
                                --bg-color: var(--strong-bg-color);
                                --progress: 20%;
                                background: linear-gradient(
                                    to right,
                                    var(--bg-color),
                                    var(--progress-color) 0%,
                                    var(--progress-color) var(--progress),
                                    var(--bg-color) var(--progress),
                                    var(--bg-color) 100%
                                );
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                            }
                            
                            /* Central Error Modal Styles */
                            #error-modal-overlay {
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100vw;
                                height: 100vh;
                                background: rgba(0, 0, 0, 0.5);
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                z-index: 10000;
                            }
                            
                            #error-modal {
                                background: var(--strong-bg-color);
                                border: 2px solid #ff4444;
                                border-radius: 8px;
                                min-width: 400px;
                                max-width: 600px;
                                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                            }
                            
                            #error-modal-header {
                                background: #ff4444;
                                color: white;
                                padding: 12px 16px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                font-weight: bold;
                                font-size: 1.1em;
                            }
                            
                            #error-modal-close {
                                background: none;
                                border: none;
                                color: white;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                            }
                            
                            #error-modal-close:hover {
                                background: rgba(255, 255, 255, 0.2);
                                border-radius: 4px;
                            }
                            
                            #error-modal-body {
                                padding: 20px;
                                display: grid;
                                gap: 12px;
                            }
                            
                            #error-modal-title {
                                font-weight: bold;
                                font-size: 1.1em;
                                color: var(--text-color);
                            }
                            
                            #error-modal-message {
                                background: var(--weak-bg-color);
                                padding: 12px;
                                border-radius: 4px;
                                font-family: monospace;
                                font-size: 0.9em;
                                word-wrap: break-word;
                                white-space: pre-wrap;
                                color: var(--text-color);
                                border-left: 4px solid #ff4444;
                            }
                            
                            #error-modal-timestamp {
                                font-size: 0.8em;
                                color: var(--text-color);
                                opacity: 0.7;
                            }
                            
                            #error-modal-footer {
                                padding: 12px 20px;
                                display: flex;
                                justify-content: flex-end;
                                border-top: 1px solid var(--highlight-color);
                            }
                            
                            #error-modal-ok {
                                background: var(--highlight-color);
                                color: white;
                                border: none;
                                padding: 8px 20px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                            }
                            
                            #error-modal-ok:hover {
                                opacity: 0.8;
                            }

                            #error-modal-reload {
                                background: #4488ff;
                                color: white;
                                border: none;
                                padding: 8px 20px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: bold;
                                margin-right: 8px;
                            }

                            #error-modal-reload:hover {
                                opacity: 0.8;
                            }

                            .cached-microscope-delete-button {
                                padding: 0.3em 0.8em;
                                background: #ff4444;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                            }

                            .cached-microscope-delete-button:hover {
                                opacity: 0.8;
                            }

                            .center-content {
                                display: grid;
                                position: relative;
                            }
                            .center-content * {
                                display: block;
                                height: min-content;
                                position: relative;
                                top: 50%;
                                transform: translateY(-50%);
                            }
                            .popup {
                                position: absolute;
                                top: 0;
                                left: 0;
                                background: var(--strong-bg-color);
                                z-index: 1;
                                transform: translateY(-100%);
                                width: 35em;
                                padding: 0.5em;
                                border: 1px solid var(--text-color);
                                border-radius: 1em;
                            }
                        </style>
                        <script>
                            // Global tracking for currently open popup
                            let currentlyOpenPopup = null;

                            function closeAllPopupsExcept(exceptPopup) {
                                if (currentlyOpenPopup !== null && currentlyOpenPopup !== exceptPopup) {
                                    makeInvisible(currentlyOpenPopup);
                                }
                                currentlyOpenPopup = exceptPopup;
                            }

                            function registerContainedPopup(el) {
                                const target_popups = el.getElementsByClassName("popup");
                                if (target_popups.length != 1) throw new Error(``);
                                const target_popup = target_popups[0];
                                let hideTimeoutId = null;
                                let isOverSpawner = false;
                                let isOverPopup = false;

                                const cancelHideTimeout = () => {
                                    if (hideTimeoutId !== null) {
                                        clearTimeout(hideTimeoutId);
                                        hideTimeoutId = null;
                                    }
                                };

                                const checkAndHide = () => {
                                    cancelHideTimeout();
                                    // Only hide if mouse is over neither element
                                    if (!isOverSpawner && !isOverPopup) {
                                        hideTimeoutId = setTimeout(() => {
                                            makeInvisible(target_popup);
                                            hideTimeoutId = null;
                                        }, interfaceSettings.popupHideDelayMs);
                                    }
                                };

                                makeInvisible(target_popup);
                                el.addEventListener("mouseenter", () => {
                                    isOverSpawner = true;
                                    cancelHideTimeout();
                                    makeVisible(target_popup);
                                    // Close any other open popup
                                    closeAllPopupsExcept(target_popup);
                                });
                                el.addEventListener("mouseleave", () => {
                                    isOverSpawner = false;
                                    checkAndHide();
                                });

                                // Also handle mouse events on the popup itself
                                target_popup.addEventListener("mouseenter", () => {
                                    isOverPopup = true;
                                    cancelHideTimeout();
                                });
                                target_popup.addEventListener("mouseleave", () => {
                                    isOverPopup = false;
                                    checkAndHide();
                                });
                            }
                            function makeVisible(el) {
                                const parentRect = el.parentElement.getBoundingClientRect();
                                
                                // Show popup temporarily to measure it
                                el.style.setProperty("display", "block");
                                el.style.setProperty("left", "0px");
                                const popupWidth = el.offsetWidth;
                                
                                // Calculate centered position on parent
                                let leftPos = parentRect.left + parentRect.width / 2 - popupWidth / 2;
                                
                                // Check right boundary
                                if (leftPos + popupWidth > window.innerWidth - 10) {
                                    leftPos = window.innerWidth - popupWidth - 10;
                                }
                                
                                // Check left boundary  
                                if (leftPos < 10) {
                                    leftPos = 10;
                                }
                                
                                // Set final position
                                el.style.setProperty("top", `${parentRect.top}px`);
                                el.style.setProperty("left", `${leftPos}px`);
                            }
                            function makeInvisible(el) {
                                el.style.setProperty("display", "none");
                            }
                        </script>
                        
                        <div style="font-size: 1.6em" class="center-content">
                            <span>Acquisition</span>
                        </div>
                        <div
                            id="acquisition-progress-bar"
                            x-init="registerContainedPopup($el)"
                            x-bind:style="`--progress:${current_acquisition_progress_percent}%;`"
                        >
                            <span>
                                <span x-text="`${latest_acquisition_status?.acquisition_status??'not running'}`"></span>
                                <span>|</span>
                                <span>Progress</span>
                                <span x-text="`${current_acquisition_progress_percent.toFixed(2)}%`"></span>
                                <span>|</span>
                                <span x-text="`Done in ${acquisitionTimeLeftString}`"></span>
                            </span>
                            
                            <div class="popup">
                                <div style="white-space: normal; font-family: monospace; font-size: 0.9em; line-height: 1.4;">
                                    <div x-text="`Status: ${latest_acquisition_status?.acquisition_status??'not running'} (${current_acquisition_progress_percent.toFixed(2)}%)`"></div>
                                    <div x-text="`Images: ${latest_acquisition_status?.acquisition_progress?.current_num_images??0} / ${latest_acquisition_status?.acquisition_meta_information?.total_num_images??0}`"></div>
                                    <div x-text="`Storage: ${(latest_acquisition_status?.acquisition_progress?.current_storage_usage_GB??0).toFixed(2)} / ${(latest_acquisition_status?.acquisition_meta_information?.max_storage_size_images_GB??0).toFixed(2)} GB`"></div>
                                    <div x-text="`Elapsed: ${acquisitionElapsedTimeString}`"></div>
                                    <div x-text="`Remaining: ${acquisitionTimeLeftString}`"></div>
                                    <div x-show="latest_acquisition_status?.acquisition_progress?.last_image" x-text="`Well: ${latest_acquisition_status?.acquisition_progress?.last_image?.position?.well_name??'--'}`"></div>
                                    <div x-show="latest_acquisition_status?.acquisition_progress?.last_image" x-text="`Site in Well: (${latest_acquisition_status?.acquisition_progress?.last_image?.position?.site_x}, ${latest_acquisition_status?.acquisition_progress?.last_image?.position?.site_y}, ${latest_acquisition_status?.acquisition_progress?.last_image?.position?.site_z})`"></div>
                                    <div x-show="latest_acquisition_status?.acquisition_progress?.last_image" x-text="`Channel: ${latest_acquisition_status?.acquisition_progress?.last_image?.channel?.name??'--'}`"></div>
                                    <div x-text="`${latest_acquisition_status?.message??''}`" x-show="latest_acquisition_status?.message"></div>
                                </div>
                            </div>
                        </div>
                        <button @click="await acquisition_start()" :disabled="isAcquisitionRunning">Start</button>
                        <button @click="await acquisition_stop()" :disabled="!isAcquisitionRunning">Cancel</button>
                    </div>
                </div>
            </div>
        </template>
    </body>
</html>
